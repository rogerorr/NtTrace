<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<link type="text/css" rel="stylesheet" href="or2.css">
<link rel="shortcut icon" href="NtTrace.ico">

<meta name="Author" content="Roger Orr">
<meta name="Description" content="NtTrace Home Page">
<meta name="Keywords" content="Roger Orr, OR/2 Limited, NtTrace, Debugging, strace, Windows, Native API">

<title>NtTrace</title>
</head>

<body>

<H3> NtTrace - Native API tracing for Windows </H3>

NtTrace provides a simple trace facility for the Windows Native API.  It is roughly equivalent to <code>strace</code> on Linux.
<br>
The native API is the interface between the application space and the OS kernel; this API is provided by <code>ntdll.dll</code>.  It is not very well documented, and changes between versions of Windows, but tracing execution of an application at this level can provide a clear view of its use of the operating system.
<p>
NtTrace uses the debugging interface on Windows to intercept the returns from the native API and display the input arguments and return code.  Return codes are translated to Window error code and error messages where possible.
<br>
(Click <a href="SimilarTools.html">here</a> for some links to other similar tools.)
<p>
<hr>
<p>

<b>Example:</b>
<code><pre>
C:> NtTrace -filter File cmd
Process 2428 starting at 4AD0B814 with command line "cmd"
Loaded DLL at 77F40000 ntdll.dll
NtOpenFile(FileHandle=0x12fb38 [0x14], DesiredAccess=SYNCHRONIZE|0x20, ObjectAttributes="\??\C:\WWW\NtTrace\", IoStatusBlock=0x0012FAE4 [0/1], ShareAccess=3, OpenOptions=0x21) => 0
NtQueryVolumeInformationFile(FileHandle=0x14, IoStatusBlock=0x0012FAE4 [0/8], FsInformation=0x12faf4, Length=8, FsInformationClass=4 [FileFsDeviceInformation]) => 0
NtFsControlFile(FileHandle=0x14, Event=0, UserApcRoutine=null, UserApcContext=null, UserIoStatus=0x0012F754 [0/0], FsControlCode=0x00090028, InputBuffer=null, InputBufferLength=0, OutputBuffer=null, OutputBufferLength=0) => 0
NtQueryAttributesFile(ObjectAttributes="\??\C:\WINDOWS\system32\cmd.exe.Local", Attributes=0x0012FADC [0]) => 0xc0000034<br> [2 'The system cannot find the file specified.']

...

NtWriteFile(FileHandle=4, Event=0, ApcRoutine=null, ApcContext=null, IoStatusBlock=0x0012FD8C [0/0x29], Buffer=0x4ad30e40, Length=0x29, ByteOffset=null, Key=null) => 0
NtQueryVolumeInformationFile(FileHandle=4, IoStatusBlock=0x0012FB80 [0/8], FsInformation=0x12fb88, Length=8, FsInformationClass=4 [FileFsDeviceInformation]) => 0
NtWriteFile(FileHandle=4, Event=0, ApcRoutine=null, ApcContext=null, IoStatusBlock=0x0012FB48 [0/2], Buffer=0x4ad30e40, Length=2, ByteOffset=null, Key=null) => 0
NtQueryVolumeInformationFile(FileHandle=4, IoStatusBlock=0x0012FB84 [0/8], FsInformation=0x12fb8c, Length=8, FsInformationClass=4 [FileFsDeviceInformation]) => 0
C:\WWW\NtTrace>NtWriteFile(FileHandle=4, Event=0, ApcRoutine=null, ApcContext=null, IoStatusBlock=0x0012FB4C [0/0xf], Buffer=0x4ad30e40, Length=0xf, ByteOffset=null, Key=null) => 0
Process 2428 exit code: 0
</pre></code>

<b>Syntax:</b><br>
&nbsp; nttrace [-a] [-e] [-v] [-config *] [-errors *] [-export *] [-filter *] [-category *] [-hd] [-nonames] [-nodlls] [-noexcept] [-out *] [-pre] [-stack] [-time] [-delta] [-pid] [-tid] [-nl] [pid | cmd <args>]
<p>
Options:<br>
<table border=0>
<tr><td>  -a        </td><td> attach to existing process &lt;cmd&gt; rather than starting a fresh &lt;cmd&gt; </td></tr>
<tr><td>  -e        </td><td> Only log errors </td></tr>
<tr><td>  -v        </td><td> More verbose logging</td></tr>
<tr><td>  -config   </td><td> Specify config file </td></tr>
<tr><td>  -errors   </td><td> Comma delimited list of error codes to filter on </td></tr>
<tr><td>  -export   </td><td> Export symbols once loaded [for testing] </td></tr>
<tr><td>  -filter   </td><td> Comma delimited list of substrings to filter on </td></tr>
<tr><td>  -category </td><td> Comma delimited list of categories to trace (eg File,Process,Registry, ? for list) *</td></tr>
<tr><td>  -hd       </td><td> Don't use debug heap</td></tr>
<tr><td>  -nonames  </td><td> Don't name arguments </td></tr>
<tr><td>  -nodlls   </td><td> Don't process DLL load/unload </td></tr>
<tr><td>  -noexcept </td><td> Don't process exceptions </td></tr>
<tr><td>  -out      </td><td> Output file </td></tr>
<tr><td>  -pre      </td><td> Trace pre-call as well as post-call </td></tr>
<tr><td>  -stack    </td><td> show stack trace </td></tr>
<tr><td>  -time     </td><td> show timestamp </td></tr>
<tr><td>  -delta    </td><td> show delta time </td></tr>
<tr><td>  -pid      </td><td> show process ID </td></tr>
<tr><td>  -nl       </td><td> force newline on OutputDebugString </td></tr>

</table>
<p>
* the full list of categories is soft-configured from NtTrace.cfg.  As supplied the list is:
<div>
Atom, Debug, Device, Environment, File, IoRing, Job,<br>
LPC, Memory, Object, Other, Process, Registry,<br>
Security, Synchronization, Time, Transaction and WOW64.

<hr>
Download NtTrace from <a href="https://github.com/rogerorr/NtTrace">GitHub<a/> and build an x86 or amd64 binary.
<p>
<b>Build instructions for Microsoft Visual Studio</b><p>
At a Visual Studio command prompt type <code>'nmake -f NtTrace.mak'</code>
<p>
Build the appropriate binary (32-bit or 64-bit) for your target program.
<ul>
<li>Windows does not support 32-bit binaries debugging 64-bit ones.
<li>While you can use a 64-bit NtTrace on 32-bit programs the output from the 32-bit NtTrace is likely to be clearer.
</ul>
<p>
(See Readme.txt for full details)
<p>

<hr>
Version 2462 - 07-Sep-2024<br>
Recent changes:
<ul>
<li>Provide extra diagnostics on incorrect signature
<li>Prefer C++11 'using' over typedefs
</ul>

<hr>
Version 2335 - 15-Oct-2022<br>
Recent changes:
<ul>
<li>New entry points for Windows 11 22H2
<li>Show command line for created processes
</ul>

<hr>
Version 2325 - 23-Sep-2022<br>
Recent changes:
<ul>
<li>Add -nodlls option
<li>Distinguish the initial process breakpoint
</ul>

<hr>
Version 2266 - 04-Nov-2021<br>
Recent changes:
<ul>
<li>First pass at adding the Windows 11 NtDll functions
</ul>

<hr>
Version 2081 - 12-Sep-2021<br>
Recent changes:
<ul>
<li>Add inline frame handling to the StackTrace functionality
<li>Replace home-grown headers with <code>cvconst.h</code>, from the DIA SDK in Visual Studio
<li>Remove conditional code needed for ancient versions of MSVC
</ul>

<hr>
Version 1918 - 24-Oct-2020<br>
Recent changes:
<ul>
<li>Split NtTrace build directory into build32 and build64
<li>Update NtDll for Windows 10 2004
<li>Consistent logging of process header
<li>Use decorated name as a fallback if unable to undecorate
</ul>

<hr>
Version 1914 - 15-Aug-2020<br>
Recent changes:
<ul>
<li>Tracked new APIS in Windows 10 (up to build 2004)
<li>Fix crash in exception logging (issue #3)
<li>Changed email address
</ul>

<hr>
Version 1818 - 18-Mar-2019<br>
Recent changes:
<ul>
<li>Added the most recent Windows 10 APIs, and categorized some of them
<li>Update some enumerations, for example Power Information, with newer values
<li>Support for user32 and gdi32 on more recent versions of Windows that use win32u.dll
<li>Add -v option to NtTrace to display address and SSN
</ul>

<hr>
Version 1439 - 16-Oct-2014<br>
Recent changes:
<ul>
<li>Clean compile with VC14 (CTP3)
<li>Add filter off logic
</ul>
Version 1396 - 03-Oct-2013<br>
Recent changes:
<ul>
<li>Ctrl+C now detaches from attached process (-a option) rather than terminating
<li>Add -nl option to force a newline on each output
<li>A few minor changes to NTDLL/Gdi32/User32 entry points
</ul>
<p>

<hr>
Version 1362 - 17-Jun-2013<br>
Change summary:
<ul>
<li>Add -config option to allow easier selection of configuration
<li>Add Gdi32Trace.cfg containing the NtGdi functions exported from Gdi32 
<li>Add User32Trace.cfg containing the NtUser functions exported from User32 
<li>A few minor changes to NTDLL entry points
<li>Better logging of 64bit C++ exceptions
<li>Display of RootDirectory for ObjectAttributes
</ul>
<p>

Version 1139 - 25-May-2012<br>
Change summary:
<p>
<ul>
<li>Add entry points for the NtWow64 functions (available to 32-bit programs on 64-bit Windows)
<li>Add names and types to a few more entry points
<li>Improve handling of duplicate/output arguments
</ul>
<p>

Version 967 - 17-Nov-2011<br>
Change summary:
<p>
<ul>
<li>Add X64 build (AMD64) - supports 32-bit and 64-bit targets
<li>Add new entry points for Windows 7
<li>Extend coverage of names for enumerated values
<li>Add basic LPC_MESSAGE unpacking
<li>Add -pre option to trace pre-call as well as post-call
<li>Don't dereference output only arguments on error
</ul>

<hr>

If you have any queries or comments about NtTrace, please email 
<script type="text/javascript">
<!--
  document.write("<a href='MAILTO:NtTrace"); 
  document.write("@");
  document.write("howzatt.co.uk'>NtTrace");
  document.write("@");
  document.write("howzatt.co.uk</a>.");
-->
</script>
<noscript>
  rogero 'at' howzatt.co.uk.
</noscript>

</body>
</html>
